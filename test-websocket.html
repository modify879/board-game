<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Lexio Game WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .log-area {
            height: 300px;
            overflow-y: scroll;
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }

        button {
            padding: 5px 10px;
            cursor: pointer;
        }

        input {
            padding: 5px;
            margin-right: 5px;
        }

        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }

        .status {
            font-weight: bold;
            color: #666;
        }

        .status.connected {
            color: green;
        }

        .status.disconnected {
            color: red;
        }

        .full-width {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸƒ Lexio WebSocket Tester</h1>

    <div class="section">
        <h3>0. JWT í† í° ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)</h3>
        <div>
            <label>User ID:</label>
            <input id="genUserId" type="number" value="1" placeholder="User ID">
            <label>Role:</label>
            <input id="genRole" type="text" value="USER" placeholder="Role">
        </div>
        <div style="margin-top: 5px;">
            <label>Secret Key:</label>
            <input id="genSecret" type="text" value="your-secret-key-change-this-in-production-minimum-256-bits" style="width: 400px;">
        </div>
        <div style="margin-top: 10px;">
            <button onclick="generateToken()">í† í° ìƒì„± ë° ì…ë ¥</button>
        </div>
    </div>

    <div class="section">
        <h3>1. ì„œë²„ ì—°ê²°</h3>
        <div>
            <label>JWT Token:</label>
            <input class="full-width" id="jwtToken" placeholder="Bearer Token (without 'Bearer ' prefix)" type="text">
        </div>
        <div style="margin-top: 10px;">
            <button onclick="connect()">Socket ì—°ê²° (SockJS)</button>
            <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
            <span class="status disconnected" id="connectionStatus">Disconnected</span>
        </div>
    </div>

    <div class="section">
        <h3>2. ê²Œì„ ìƒì„±</h3>
        <div style="margin-top: 10px;">
            <button onclick="createGame()">ìƒˆ ê²Œì„ ìƒì„±</button>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                â€» ìƒì„±ëœ Game IDê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <div class="section">
        <h3>3. ê²Œì„ ì°¸ê°€ ë° êµ¬ë…</h3>
        <div>
            <label>Game ID:</label>
            <input id="gameId" placeholder="UUID ì…ë ¥ (ì˜ˆ: 550e8400...)" style="width: 300px;" type="text">
        </div>
        <div style="margin-top: 10px;">
            <button onclick="joinAndSubscribe()">ê²Œì„ ì°¸ê°€ ë° êµ¬ë…</button>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                â€» ì°¸ê°€ì™€ êµ¬ë…ì´ ë™ì‹œì— ìˆ˜í–‰ë©ë‹ˆë‹¤. User IDëŠ” JWT í† í°ì—ì„œ ìë™ìœ¼ë¡œ ì¶”ì¶œë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <div class="section">
        <h3>4. ì•¡ì…˜ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="sendToggleReady()">ì¤€ë¹„ í† ê¸€ (Ready/Unready)</button>
        <button onclick="sendPassTurn()">í„´ íŒ¨ìŠ¤ (Pass)</button>
        <br><br>
        <div>
            <label>íƒ€ì¼ ë‚´ê¸°:</label>
            <input id="playTiles" placeholder='[{"number":2,"suit":"SUN"}]' style="width: 400px;"
                   type="text">
            <button onclick="sendPlayTurn()">íƒ€ì¼ ì œì¶œ</button>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
                â€» powerëŠ” ì„œë²„ì—ì„œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤ (numberì™€ suitë§Œ ì…ë ¥)
            </p>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ“œ ë©”ì‹œì§€ ë¡œê·¸</h3>
        <button onclick="clearLog()" style="float: right; font-size: 0.8em;">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <div class="log-area" id="logArea"></div>
    </div>
</div>

<script>
    var stompClient = null;
    var currentSubscription = null;

    function generateToken() {
        var userId = document.getElementById('genUserId').value;
        var role = document.getElementById('genRole').value;
        var secret = document.getElementById('genSecret').value;

        if (!userId || !role || !secret) {
            alert('User ID, Role, Secret Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // Header
        var header = {alg: "HS256"};

        // Payload
        var tNow = Math.floor(Date.now() / 1000);
        var tEnd = tNow + (30 * 60); // 30 mins
        var payload = {
            sub: userId,
            role: role,
            iat: tNow,
            exp: tEnd
        };

        try {
            var token = KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), secret);
            document.getElementById('jwtToken').value = token;
            log('JWT Token Generated for User ' + userId);
        } catch (e) {
            log('Token Generation Failed: ' + e, 'error');
            alert('í† í° ìƒì„± ì‹¤íŒ¨: ' + e);
        }
    }

    function log(message, type = 'info') {
        var logArea = document.getElementById('logArea');
        var p = document.createElement('p');
        p.style.margin = '2px 0';
        p.style.color = type === 'error' ? 'red' : (type === 'rx' ? 'blue' : 'black');
        p.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
        logArea.appendChild(p);
        logArea.scrollTop = logArea.scrollHeight;
    }

    function clearLog() {
        document.getElementById('logArea').innerHTML = '';
    }

    function connect() {
        var token = document.getElementById('jwtToken').value.trim();
        if (!token) {
            alert('JWT Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        var socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        // ë””ë²„ê·¸ ë¡œê·¸ ë„ê¸° (ë„ˆë¬´ ì‹œë„ëŸ¬ìš°ë©´)
        // stompClient.debug = null;

        var headers = {
            'Authorization': 'Bearer ' + token
        };

        stompClient.connect(headers, function (frame) {
            document.getElementById('connectionStatus').innerText = 'Connected';
            document.getElementById('connectionStatus').className = 'status connected';
            log('Connected: ' + frame);
        }, function (error) {
            log('Connection Error: ' + error, 'error');
            document.getElementById('connectionStatus').innerText = 'Disconnected';
            document.getElementById('connectionStatus').className = 'status disconnected';
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('connectionStatus').innerText = 'Disconnected';
        document.getElementById('connectionStatus').className = 'status disconnected';
        log('Disconnected');
    }

    function createGame() {
        var token = document.getElementById('jwtToken').value.trim();
        if (!token) {
            alert('JWT Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        log('Creating new game...');
        fetch('http://localhost:8080/api/lexio/games', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'ê²Œì„ ìƒì„± ì‹¤íŒ¨');
                });
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('gameId').value = data.gameId;
            log(`âœ… Game Created: ${data.gameId}`, 'info');
        })
        .catch(error => {
            log('Game Creation Failed: ' + error.message, 'error');
            alert('ê²Œì„ ìƒì„± ì‹¤íŒ¨: ' + error.message);
        });
    }

    function joinAndSubscribe() {
        var gameId = document.getElementById('gameId').value.trim();
        var token = document.getElementById('jwtToken').value.trim();
        
        if (!gameId) {
            alert('Game IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        if (!token) {
            alert('JWT Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € ì„œë²„ì— ì—°ê²°í•˜ì„¸ìš”.');
            return;
        }

        // 1. ê²Œì„ ì°¸ê°€ (REST API)
        log(`Joining game ${gameId}...`);
        fetch(`http://localhost:8080/api/lexio/games/${gameId}/join`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'ê²Œì„ ì°¸ê°€ ì‹¤íŒ¨');
                });
            }
            return response.json();
        })
        .then(data => {
            log(`âœ… Joined game: ${gameId}`, 'info');
            
            // 2. êµ¬ë… (WebSocket)
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            log(`Subscribing to /user/queue/game/${gameId}...`);
            currentSubscription = stompClient.subscribe(`/user/queue/game/${gameId}`, function (message) {
                log(`ğŸ“© Received Update: ${message.body}`, 'rx');
                // JSON íŒŒì‹±í•´ì„œ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥ ê°€ëŠ¥
                try {
                    var data = JSON.parse(message.body);
                    console.log("Game Data:", data);
                    
                    // í˜„ì¬ ì°¨ë¡€ í”Œë ˆì´ì–´ ì •ë³´ í‘œì‹œ
                    if (data.currentTurnPlayerId) {
                        var currentTurnPlayer = data.players.find(function(p) {
                            return p.userId === data.currentTurnPlayerId;
                        });
                        if (currentTurnPlayer) {
                            log(`ğŸ¯ í˜„ì¬ ì°¨ë¡€: ${currentTurnPlayer.name} (User ID: ${currentTurnPlayer.userId})`, 'info');
                        } else {
                            log(`ğŸ¯ í˜„ì¬ ì°¨ë¡€: User ID ${data.currentTurnPlayerId}`, 'info');
                        }
                    } else {
                        log(`â¸ï¸ í˜„ì¬ ì°¨ë¡€ ì—†ìŒ (ê²Œì„ ëŒ€ê¸° ì¤‘)`, 'info');
                    }
                    
                    // ê° í”Œë ˆì´ì–´ì˜ ì°¨ë¡€ ì—¬ë¶€ í‘œì‹œ
                    data.players.forEach(function(player) {
                        if (player.isCurrentTurn) {
                            log(`   âœ“ ${player.name}ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤`, 'info');
                        }
                    });
                } catch (e) {
                }
            });
            log(`âœ… Subscribed to game updates`, 'info');
        })
        .catch(error => {
            log('Join Failed: ' + error.message, 'error');
            alert('ê²Œì„ ì°¸ê°€ ì‹¤íŒ¨: ' + error.message);
        });
    }

    function sendToggleReady() {
        var gameId = document.getElementById('gameId').value.trim();

        if (!gameId) {
            alert('Game IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        log(`Sending Ready Toggle...`);
        stompClient.send(`/app/game/${gameId}/ready`, {}, {}); // userIdëŠ” ì„œë²„ì—ì„œ ìë™ ì¶”ì¶œ
    }

    function sendPassTurn() {
        var gameId = document.getElementById('gameId').value.trim();

        if (!gameId) {
            alert('Game IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        log(`Sending Pass Turn...`);
        stompClient.send(`/app/game/${gameId}/pass`, {}, {}); // userIdëŠ” ì„œë²„ì—ì„œ ìë™ ì¶”ì¶œ
    }

    function sendPlayTurn() {
        var gameId = document.getElementById('gameId').value.trim();
        var tilesJson = document.getElementById('playTiles').value.trim();

        if (!gameId) {
            alert('Game IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            var tiles = JSON.parse(tilesJson);
            var payload = JSON.stringify({
                tiles: tiles
            });
            log(`Sending Play Turn: ${payload}`);
            stompClient.send(`/app/game/${gameId}/play`, {}, payload);
        } catch (e) {
            alert('íƒ€ì¼ JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
    }
</script>
</body>
</html>
